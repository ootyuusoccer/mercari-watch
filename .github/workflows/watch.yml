name: Mercari Watch

on:
  schedule:
    - cron: "*/15 * * * *"   # 15åˆ†ã”ã¨ã«å®Ÿè¡Œ
  workflow_dispatch:         # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯

permissions:
  contents: write   # last_seen.json ã‚’ã‚³ãƒŸãƒƒãƒˆ
  issues: write     # é€šçŸ¥ã¨ã—ã¦ Issue ã‚’ä½œæˆ

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm i -D playwright@1.44.0

      - name: Install Playwright (browsers)
        run: |
          npx playwright install --with-deps chromium

      - name: Run Mercari Watcher
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node <<'EOF'
          import fs from 'fs';
          import { chromium } from 'playwright';

          // ---- helpers ----
          const REPO = process.env.GITHUB_REPOSITORY;      // owner/repo
          const TOKEN = process.env.GITHUB_TOKEN;
          const [OWNER, REPO_NAME] = REPO.split('/');

          const readCSV = (path) =>
            fs.readFileSync(path, 'utf8')
              .trim().split('\n').slice(1)
              .map(line => {
                const [name, url] = line.split(',');
                return { name: name.trim(), url: url.trim() };
              });

          const readLastSeen = (path) =>
            fs.existsSync(path) ? JSON.parse(fs.readFileSync(path, 'utf8')) : {};

          const writeLastSeen = (path, obj) =>
            fs.writeFileSync(path, JSON.stringify(obj, null, 2));

          // ---- main ----
          const targets = readCSV('targets.csv');       // name,url,(max_price) ã®CSV
          const lastSeen = readLastSeen('last_seen.json');

          const browser = await chromium.launch();
          const ctx = await browser.newContext({
            userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124 Safari/537.36',
            locale: 'ja-JP'
          });
          const page = await ctx.newPage();

          const newFinds = [];

          for (const t of targets) {
            // æ–°ç€é †ä»˜ä¸ï¼ˆç„¡ã‘ã‚Œã°ï¼‰
            let url = t.url;
            if (!/sort=created_time/.test(url)) {
              url += (url.includes('?') ? '&' : '?') + 'sort=created_time&order=desc';
            }

            console.log(`ğŸ” Checking: ${t.name}`);
            await page.goto(url, { waitUntil: 'networkidle' });

            // å…ˆé ­å•†å“IDã‚’HTMLã‹ã‚‰æ‹¾ã†
            const html = await page.content();
            const m = html.match(/\/item\/(m[0-9A-Za-z]+)/);
            const newId = m ? m[1] : null;

            if (!newId) {
              console.log(`âš ï¸ ${t.name}: å…ˆé ­å•†å“IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ`);
              continue;
            }

            const prev = lastSeen[t.name];
            console.log(`   id(new)=${newId}  id(prev)=${prev || '(none)'}`);

            if (!prev || prev !== newId) {
              newFinds.push({ ...t, newId });
              lastSeen[t.name] = newId;   // æ›´æ–°
            }
          }

          await browser.close();

          // é€šçŸ¥ï¼ˆIssueä½œæˆï¼‰â€»GitHubã®é€šçŸ¥è¨­å®šã§å—ã‘å–ã‚Œã‚‹
          if (newFinds.length) {
            const title = `ğŸ†• Mercari æ–°ç€ ${newFinds.length} ä»¶`;
            const lines = newFinds.map(n =>
              `- **${n.name}**\n  https://jp.mercari.com/item/${n.newId}\n  æ¤œç´¢: ${n.url}`
            ).join('\n\n');
            const body = `ä»¥ä¸‹ã®æ¤œç´¢ã§æ–°ç€ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚\n\n${lines}\n\n_auto via GitHub Actions_`;

            await fetch(`https://api.github.com/repos/${OWNER}/${REPO_NAME}/issues`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${TOKEN}`,
                'Accept': 'application/vnd.github+json'
              },
              body: JSON.stringify({ title, body })
            });
            console.log('ğŸ“£ Issue é€šçŸ¥ã‚’ä½œæˆã—ã¾ã—ãŸ');
          } else {
            console.log('âœ… æ–°ç€ãªã—');
          }

          // è¨˜éŒ²ã‚’ä¿å­˜
          writeLastSeen('last_seen.json', lastSeen);
          console.log('ğŸ’¾ last_seen.json ã‚’æ›´æ–°');
          EOF

      - name: Commit last_seen.json
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add last_seen.json
          git commit -m "chore: update last_seen" || echo "no changes"
          git push
