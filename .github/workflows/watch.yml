name: Mercari Watch

on:
  schedule:
    - cron: "*/15 * * * *" # 15åˆ†ã”ã¨ã«å®Ÿè¡Œ
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set Up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install playwright@1.44.0 node-fetch@3.3.2

      - name: Install Playwright (browsers)
        run: |
          npm i -D playwright
          npx playwright install --with-deps chromium

      - name: Run Mercari Watcher
        run: |
          node <<'EOF'
          import fs from 'fs';
          import fetch from 'node-fetch';
          import { chromium } from 'playwright';

          const targets = fs.readFileSync('targets.csv', 'utf8')
            .trim()
            .split('\n')
            .slice(1)
            .map(line => {
              const [name, url, max_price] = line.split(',');
              return { name, url, max_price: parseInt(max_price, 10) };
            });

          const browser = await chromium.launch();
          const page = await browser.newPage();

          for (const t of targets) {
            console.log(`ğŸ” Checking: ${t.name}`);
            await page.goto(t.url, { waitUntil: 'domcontentloaded', timeout: 60000 });

            const priceElements = await page.$$eval('div[data-testid="item-price"]', els =>
                els.map(e => e.textContent)
            );

            const prices = priceElements
              .map(p => p.replace(/[^\d]/g, ''))
              .filter(p => p)
              .map(Number);

            if (prices.length > 0) {
              const minPrice = Math.min(...prices);
              console.log(`ğŸ’° ${t.name}: æœ€å®‰å€¤ ${minPrice}å†† (ä¸Šé™ ${t.max_price}å††)`);

              if (minPrice <= t.max_price) {
                console.log(`ğŸš¨ æ¡ä»¶ä¸€è‡´: ${t.name} ãŒ ${minPrice}å††ã§å‡ºå“ä¸­ï¼`);
              }
            } else {
              console.log(`âš ï¸ ${t.name}: ä¾¡æ ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ`);
            }
          }

          await browser.close();
          console.log("âœ… Watch å®Œäº†");
          EOF
