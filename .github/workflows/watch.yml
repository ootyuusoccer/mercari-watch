name: Mercari Watch

on:
  schedule:
    - cron: "*/15 * * * *"   # 15åˆ†ã”ã¨
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Playwright å®Ÿè¡Œã«å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å…ˆã«å…¥ã‚Œã‚‹ï¼ˆUbuntu 24.04 å¯¾å¿œï¼‰
      - name: Install Playwright (browsers)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2t64 \
            libnss3 \
            libxss1 \
            libgtk-3-0 \
            libx11-xcb1 \
            libxcb1 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            libgbm1 \
            libpango-1.0-0 \
            libcairo2 \
            libatspi2.0-0 \
            libdrm2
          npm i -D playwright
          npx playwright install --with-deps chromium

      # ã“ã“ã§å®Ÿéš›ã®ç›£è¦–ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œï¼ˆ1å›ã® Chromium ã§é †ã«å·¡å›ï¼‰
      - name: Run Mercari Watcher
        env:
          GITHUB_STEP_SUMMARY: ${{ github.step_summary }}
        run: |
          node <<'EOF'
          import fs from 'fs';
          import { chromium } from 'playwright';

          // CSV: name,url,max_price
          const csvPath = 'targets.csv';
          if (!fs.existsSync(csvPath)) {
            console.log('targets.csv ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); process.exit(0);
          }
          const lines = fs.readFileSync(csvPath,'utf8')
            .split('\n').map(s=>s.trim()).filter(Boolean);
          const header = lines.shift(); // 1è¡Œç›®ãƒ˜ãƒƒãƒ€
          const targets = lines.map(l=>{
            const [name,url,max_price] = l.split(',');
            return { name, url, maxPrice: parseInt(max_price||'0',10) || 0 };
          });

          // æ—¢çŸ¥IDã‚’ä¿å­˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
          const seenPath = 'last_seen.json';
          let seen = {};
          try { seen = JSON.parse(fs.readFileSync(seenPath,'utf8')); } catch {}

          const browser = await chromium.launch({ headless: true });
          const page = await browser.newPage();

          const foundMsgs = [];
          for (const t of targets) {
            if (!t.url) continue;
            console.log(`ğŸ” Checking: ${t.name}`);

            // æ¤œç´¢ãƒšãƒ¼ã‚¸ã¸é·ç§»
            await page.goto(t.url, { waitUntil: 'domcontentloaded', timeout: 60000 });

            // SPA ãŒæŠ•ã’ã‚‹ API å¿œç­”ã‚’å¾…ã¤ï¼ˆentities:searchï¼‰
            let data = null;
            try {
              const resp = await page.waitForResponse(
                r => r.url().includes('/v2/entities:search') && r.ok(),
                { timeout: 15000 }
              );
              data = await resp.json();
            } catch (e) {
              console.log(`âš ï¸ ${t.name}: ä¾¡æ ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ`);
              continue;
            }

            const item = (data?.items && data.items[0]) ? data.items[0] : null;
            if (!item) { 
              console.log(`âš ï¸ ${t.name}: ãƒ’ãƒƒãƒˆ0ä»¶`); 
              continue; 
            }

            const id = item.id;
            const price = parseInt(item.price || '0',10);
            const status = item.status || '';
            const url = `https://jp.mercari.com/item/${id}`;

            // æ–°è¦å‡ºå“ & ä¸Šé™ä¾¡æ ¼ä»¥ä¸‹ & è²©å£²ä¸­ ã‚’é€šçŸ¥å¯¾è±¡ã«
            const isNew = seen[t.name] !== id;
            const isOnSale = status.includes('TRADING') || status.includes('ON_SALE') || status === 'ITEM_STATUS_TRADING';
            const priceOk = (t.maxPrice === 0) || (price > 0 && price <= t.maxPrice);

            if (isNew && isOnSale && priceOk) {
              foundMsgs.push(`- **${t.name}** æ–°ç€: Â¥${price.toLocaleString()} â†’ ${url}`);
              seen[t.name] = id;  // è¨˜éŒ²æ›´æ–°
            } else {
              // åˆå›å®Ÿè¡Œã§å­¦ç¿’ã ã‘ï¼ã¾ãŸã¯æ¡ä»¶åˆã‚ãš
              if (!seen[t.name]) seen[t.name] = id;
            }
          }

          await browser.close();

          // çµæœã‚’ Summary ã«æ›¸ãï¼ˆGitHub Actions ç”»é¢ã§è¦‹ãˆã‚‹ï¼‰
          const linesOut = [];
          if (foundMsgs.length) {
            linesOut.push('## ğŸ› æ–°ç€æ¤œå‡º\n', ...foundMsgs, '\n');
          } else {
            linesOut.push('æ–°ç€ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
          }
          fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY || 'summary.md', linesOut.join('\n'));

          // çŠ¶æ…‹ã‚’ä¿å­˜
          fs.writeFileSync(seenPath, JSON.stringify(seen, null, 2));
          console.log('Watch å®Œäº†');
          EOF

      # å¤‰æ›´ãŒã‚ã‚Œã° last_seen.json ã‚’ã‚³ãƒŸãƒƒãƒˆï¼ˆåˆå›å­¦ç¿’ã‚„æ–°ç€æ™‚ã«æ›´æ–°ï¼‰
      - name: Commit last_seen.json
        run: |
          if git status --porcelain | grep -q "last_seen.json"; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add last_seen.json
            git commit -m "chore: update last_seen.json"
            git push
          else
            echo "last_seen.json ã®å¤‰æ›´ãªã—"
          fi
