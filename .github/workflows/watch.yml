name: Mercari Watch

on:
  schedule:
    - cron: "*/15 * * * *"   # 15åˆ†ã”ã¨
  workflow_dispatch:

permissions:
  contents: write   # last_seen.json ã‚’ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ãŸã‚

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Playwright ã®ä¾å­˜&ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å…¬å¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ä¸€æ‹¬å°å…¥ï¼ˆlibasoundç³»ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ï¼‰
      - name: Install Playwright browsers & deps
        uses: microsoft/playwright-github-action@v1
        with:
          with-deps: true

      - name: Install npm deps
        run: |
          npm i nodemailer@6 playwright@1

      - name: Run Mercari Watcher
        env:
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          MAIL_TO: ${{ secrets.MAIL_TO }}
        run: |
          node --input-type=module <<'EOF'
          import fs from 'fs';
          import { chromium } from 'playwright';
          import nodemailer from 'nodemailer';

          // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
          const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

          // CSVèª­ã¿è¾¼ã¿ï¼ˆãƒ˜ãƒƒãƒ€å³å¯†é™¤å¤–ãƒ»å…¨è§’ã‚«ãƒ³ãƒå¯¾ç­–ãƒ»å£Šã‚Œè¡Œã‚¹ã‚­ãƒƒãƒ—ï¼‰
          const raw = fs.readFileSync('targets.csv','utf8').replace(/\uFEFF/g,'');
          const lines = raw.split(/\r?\n/).map(l=>l.replace(/\s+$/,'')).filter(l=>l.trim());
          const dataLines = lines.filter((l,i)=> i!==0 && !/^name\s*,\s*url\s*,\s*max_price\s*$/i.test(l.trim()));

          const targets = [];
          for (let i=0;i<dataLines.length;i++){
            const line = dataLines[i].replace(/ï¼Œ/g, ',').trim();
            const parts = line.split(',');
            if (parts.length < 3){ console.log(`â›” åˆ—ä¸è¶³: ${line}`); continue; }
            const name = parts[0].trim();
            const urlStr = parts.slice(1, parts.length-1).join(',').trim();
            const priceStr = parts[parts.length-1].trim();
            if (!/^https?:\/\//.test(urlStr)){ console.log(`â›” URLä¸æ­£: ${urlStr}`); continue; }
            let url; try{ url = new URL(urlStr).toString(); }catch{ console.log(`â›” URLæ§‹æ–‡: ${urlStr}`); continue; }
            const max_price = Number(priceStr.replace(/[^\d]/g,''));
            if (!Number.isFinite(max_price)){ console.log(`â›” max_priceä¸æ­£: ${priceStr}`); continue; }
            targets.push({ name, url, max_price });
          }

          if (targets.length===0){
            console.log('â›” æœ‰åŠ¹ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ0ã€‚CSVã®3åˆ—/URL/ä½™è¨ˆãªç©ºç™½ã‚’ç¢ºèªã—ã¦ã€‚');
            process.exit(1);
          }
          console.log('âœ… æœ‰åŠ¹ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ•°:', targets.length);

          // last_seen ã®èª­ã¿æ›¸ã
          let lastSeen = {};
          try { lastSeen = JSON.parse(fs.readFileSync('last_seen.json','utf8')); } catch {}
          
          // ãƒ¡ãƒ¼ãƒ«é€ä¿¡å™¨
          const toAddr = process.env.MAIL_TO?.trim() || process.env.MAIL_USERNAME;
          const transporter = nodemailer.createTransport({
            host: 'smtp.gmail.com',
            port: 465,
            secure: true,
            auth: { user: process.env.MAIL_USERNAME, pass: process.env.MAIL_PASSWORD },
          });

          // Playwrightèµ·å‹•
          const browser = await chromium.launch();
          const ctx = await browser.newContext({
            userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0 Safari/537.36',
            locale: 'ja-JP',
          });
          const page = await ctx.newPage();

          // Mercariæ¤œç´¢ â†’ XHR /v2/entities:search ã‚’å‚å—ã—ã¦æœ€æ–°å•†å“å–å¾—
          async function fetchLatestItem(searchUrl){
            let latest = null;

            const respWait = page.waitForResponse(resp => {
              try {
                const u = new URL(resp.url());
                return u.hostname.endsWith('api.mercari.jp') && u.pathname.includes('/v2/entities:search');
              } catch { return false; }
            }, { timeout: 15000 }).catch(() => null);

            // æ¤œç´¢URLã¸
            await page.goto(searchUrl, { waitUntil: 'domcontentloaded', timeout: 30000 });

            const apiResp = await respWait;
            if (apiResp && apiResp.ok()){
              try{
                const json = await apiResp.json();
                const item = json?.items?.[0];
                if (item){
                  latest = {
                    id: item.id || item?.item?.id,
                    name: item.name || item?.item?.name,
                    price: Number(item.price || item?.item?.price || 0),
                    created: item.created || item?.item?.created,
                    url: item.id ? `https://jp.mercari.com/item/${item.id}` : null,
                    thumb: (item.thumbnails && item.thumbnails[0]) || null
                  };
                }
              }catch(e){ /* ã ã‚“ã¾ã‚Š */ }
            }

            // ä¸‡ä¸€å–ã‚Œãªã‘ã‚Œã°æ¬¡å–„ç­–ï¼šHTMLã‹ã‚‰ item/xxxxxxxx ã‚’æŠœã
            if (!latest){
              const html = await page.content();
              const m = html.match(/\/item\/([m0-9A-Za-z]{10,})/);
              if (m){
                latest = { id: m[1], url: `https://jp.mercari.com/item/${m[1]}` };
              }
            }
            return latest;
          }

          // é€šçŸ¥æœ¬æ–‡
          function buildMailHtml(t, latest){
            const lines = [
              `<b>${t.name}</b> ã«æ–°ç€ã¾ãŸã¯æ¡ä»¶ä¸€è‡´:`,
              latest.name ? `<div>ã‚¿ã‚¤ãƒˆãƒ«: ${latest.name}</div>` : '',
              latest.price ? `<div>ä¾¡æ ¼: Â¥${latest.price.toLocaleString()}</div>` : '',
              latest.url ? `<div><a href="${latest.url}">${latest.url}</a></div>` : '',
              `<div>æ¤œç´¢URL: <a href="${t.url}">${t.url}</a></div>`
            ].filter(Boolean).join('');
            return `<div>${lines}</div>`;
          }

          let changed = false;

          for (const t of targets){
            console.log(`ğŸ” Checking: ${t.name}`);
            try {
              const latest = await fetchLatestItem(t.url);
              if (!latest || !latest.id){
                console.log(`âš  ${t.name}: ä¾¡æ ¼/IDã®å–å¾—ä¸å¯`);
                continue;
              }

              // æ–°ç€ or ä¾¡æ ¼æ¡ä»¶
              const prev = lastSeen[t.name];
              const isNew = prev !== latest.id;
              const priceOk = !t.max_price || (latest.price>0 && latest.price <= t.max_price);

              if (isNew || priceOk){
                // ãƒ¡ãƒ¼ãƒ«é€šçŸ¥
                if (!process.env.MAIL_USERNAME || !process.env.MAIL_PASSWORD){
                  console.log('âš  ãƒ¡ãƒ¼ãƒ«Secretsæœªè¨­å®šï¼ˆMAIL_USERNAME/MAIL_PASSWORDï¼‰');
                } else {
                  const subject = `Mercari: ${t.name} ${isNew ? 'æ–°ç€' : 'æ›´æ–°'} / Â¥${(latest.price||0).toLocaleString()}`;
                  await transporter.sendMail({
                    from: process.env.MAIL_USERNAME,
                    to: toAddr,
                    subject,
                    html: buildMailHtml(t, latest),
                  });
                  console.log(`ğŸ“§ é€šçŸ¥é€ä¿¡: ${subject}`);
                }
              }

              // æ—¢èª­IDæ›´æ–°
              if (prev !== latest.id){
                lastSeen[t.name] = latest.id;
                changed = true;
              }

              await sleep(1000); // è² è·&BANå›é¿ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«
            } catch(e){
              console.log(`â›” ${t.name}: ${e?.message||e}`);
            }
          }

          await browser.close();

          // å¤‰æ›´ã‚ã‚Œã° last_seen.json ã‚’ä¿å­˜
          if (changed){
            fs.writeFileSync('last_seen.json', JSON.stringify(lastSeen, null, 2));
            console.log('ğŸ’¾ last_seen.json ã‚’æ›´æ–°');
          } else {
            console.log('â€” å¤‰æ›´ãªã— â€”');
          }
          EOF

      - name: Commit last_seen.json
        if: always()
        run: |
          if git status --porcelain | grep -q "last_seen.json"; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add last_seen.json
            git commit -m "chore: update last_seen.json"
            git push
          else
            echo "No changes to commit."
          fi
