name: Mercari Watch

on:
  schedule:
    - cron: "*/15 * * * *"   # 15åˆ†ã”ã¨
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-22.04   # â† 22.04å›ºå®šã§ä¾å­˜è§£æ±º

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install packages
        run: npm i -D playwright@1.48.2 node-fetch@3.3.2 nodemailer@6.9.13

      - name: Install Playwright browsers & deps
        run: npx playwright install --with-deps chromium

      - name: Run Mercari Watcher
        env:
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}   # é€ä¿¡å…ƒGmailã‚¢ãƒ‰ãƒ¬ã‚¹
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}   # ã‚¢ãƒ—ãƒªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
          MAIL_TO:       ${{ secrets.MAIL_TO }}         # å—ä¿¡å…ˆ
        shell: bash
        run: |
          node <<'EOF'
          import fs from 'fs';
          import fetch from 'node-fetch';
          import { chromium } from 'playwright';
          import nodemailer from 'nodemailer';

          // ===== è¨­å®š =====
          const TARGETS_CSV = 'targets.csv';
          const STATE_FILE  = 'last_seen.json';
          const TIMEOUT_MS  = 45_000;        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
          const HEADLESS    = true;

          // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
          const sleep = ms => new Promise(r => setTimeout(r, ms));
          function parseCsv(text){
            return text.split(/\r?\n/).filter(l=>l.trim())
              .map((l,idx)=>{
                // name,url,max_price ã®3åˆ—ã€‚ã‚«ãƒ³ãƒã¯2ã¤ã ã‘è¨±å¯
                const m = l.match(/^([^,]+),([^,]+),([^,]+)$/);
                if(!m) throw new Error(`CSV è¡Œ${idx+1}ãŒä¸æ­£: ${l}`);
                return { name: m[1].trim(), url: m[2].trim(), max: parseInt(m[3],10) };
              });
          }
          function ensureNewestSort(u){
            // created_time desc ã‚’å¼·åˆ¶ä»˜ä¸
            const hasSort = /[?&]sort=created_time(&|$)/.test(u);
            const hasOrder = /[?&]order=desc(&|$)/.test(u);
            let url = new URL(u);
            if(!hasSort)  url.searchParams.set('sort','created_time');
            if(!hasOrder) url.searchParams.set('order','desc');
            return url.toString();
          }

          // ===== èª­ã¿è¾¼ã¿ =====
          if(!fs.existsSync(TARGETS_CSV)) throw new Error('targets.csv ãŒã‚ã‚Šã¾ã›ã‚“');
          const targets = parseCsv(fs.readFileSync(TARGETS_CSV, 'utf8')).map(t=>({
            ...t, url: ensureNewestSort(t.url)
          }));
          let state = {};
          if(fs.existsSync(STATE_FILE)){
            try { state = JSON.parse(fs.readFileSync(STATE_FILE,'utf8')); } catch {}
          }

          // ===== Gmail é€ä¿¡å™¨ =====
          const { MAIL_USERNAME, MAIL_PASSWORD, MAIL_TO } = process.env;
          const transporter = nodemailer.createTransport({
            service: 'gmail',
            auth: { user: MAIL_USERNAME, pass: MAIL_PASSWORD }
          });
          async function notify(subject, html){
            if(!MAIL_TO || !MAIL_USERNAME || !MAIL_PASSWORD){
              console.log('âš ï¸ ãƒ¡ãƒ¼ãƒ«è¨­å®šãŒæœªå…¥åŠ›ã®ãŸã‚é€šçŸ¥ã‚¹ã‚­ãƒƒãƒ—');
              return;
            }
            await transporter.sendMail({
              from: MAIL_USERNAME,
              to: MAIL_TO,
              subject,
              html
            });
          }

          // ===== ã‚¯ãƒ­ãƒ¼ãƒ«æœ¬ä½“ =====
          const browser = await chromium.launch({ headless: HEADLESS });
          const ctx = await browser.newContext({
            userAgent:
              'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124 Safari/537.36',
            locale: 'ja-JP'
          });

          const results = [];
          for(const t of targets){
            console.log(`ğŸ” Checking: ${t.name}`);
            const page = await ctx.newPage();
            page.setDefaultTimeout(TIMEOUT_MS);

            try{
              await page.goto(t.url, { waitUntil: 'domcontentloaded' });

              // Next.js ã® __NEXT_DATA__ ã‹ã‚‰æ¤œç´¢çµæœã‚’å–å¾—ï¼ˆentities:searchã®åæ˜ æ¸ˆã¿JSONãŒå…¥ã‚‹ï¼‰
              const data = await page.evaluate(()=>{
                const s = document.querySelector('#__NEXT_DATA__');
                if(!s) return null;
                try{ return JSON.parse(s.textContent); }catch{ return null; }
              });

              let first = null;

              // â‘  __NEXT_DATA__ ã« items ãŒã‚ã‚‹å ´åˆï¼ˆå„ªå…ˆï¼‰
              if(data){
                // æ·±ã„éšå±¤ã‹ã‚‰ items ã‚’æ¢ã™
                const stack = [data];
                while(stack.length){
                  const v = stack.pop();
                  if(v && typeof v==='object'){
                    if(Array.isArray(v)){
                      for(const x of v) stack.push(x);
                    }else{
                      if(v.items && Array.isArray(v.items) && v.items.length){
                        first = v.items[0];
                        break;
                      }
                      for(const k of Object.keys(v)) stack.push(v[k]);
                    }
                  }
                }
              }

              // â‘¡ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼š/m[0-9a-zA-Z]+/ ã‚’ a[href] ã‹ã‚‰æ‹¾ã†
              if(!first){
                const id = await page.evaluate(()=>{
                  const a = document.querySelector('a[href*="/item/"]');
                  if(!a) return null;
                  const m = a.getAttribute('href').match(/\/(m[0-9a-zA-Z]+)(?:\?|\/|$)/);
                  return m ? m[1] : null;
                });
                if(id){
                  first = { id, name: t.name, price: null, thumbnails: [] };
                }
              }

              if(!first){
                console.log(`âš ï¸ ${t.name}: å…ˆé ­å•†å“ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ`);
                await page.close();
                continue;
              }

              const id = first.id || first.itemId || first.item_id;
              if(!id){
                console.log(`âš ï¸ ${t.name}: IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`);
                await page.close();
                continue;
              }

              const prev = state[t.name];
              if(prev && prev === id){
                console.log(`= ${t.name}: æ–°è¦ãªã—`);
              }else{
                // ä¾¡æ ¼ã‚’HTMLã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§æ‹¾ã†ï¼ˆä»»æ„ï¼‰
                let price = null;
                try{
                  price = await page.evaluate(()=>{
                    const n = document.querySelector('[data-testid="price"], [class*="Price"]');
                    if(!n) return null;
                    const s = n.textContent.replace(/[^\d]/g,'');
                    return s ? parseInt(s,10) : null;
                  });
                }catch{}

                // é€šçŸ¥æœ¬æ–‡
                const itemUrl = `https://jp.mercari.com/item/${id}`;
                const html = `
                  <div>
                    <div><b>${t.name}</b> ã«æ–°ç€</div>
                    <div>ID: ${id}</div>
                    ${price ? `<div>ä¾¡æ ¼: Â¥${price.toLocaleString()}</div>` : ''}
                    <div><a href="${itemUrl}">${itemUrl}</a></div>
                    <div>æ¤œç´¢: <a href="${t.url}">${t.url}</a></div>
                  </div>
                `;

                // ä¾¡æ ¼æ¡ä»¶
                const okByPrice = (price==null) || (isFinite(t.max) && price <= t.max);
                const subject = okByPrice
                  ? `ã€æ–°ç€ã€‘${t.name} ${price?`Â¥${price}`:''}`
                  : `ã€æ–°ç€(ä¸Šé™è¶…ãˆ)ã€‘${t.name} ${price?`Â¥${price}`:''}`;

                await notify(subject, html);
                console.log(`âœ… é€šçŸ¥: ${t.name} id=${id}`);

                // çŠ¶æ…‹æ›´æ–°
                state[t.name] = id;
              }

              await page.close();
              await sleep(500);
            }catch(e){
              console.log(`âŒ ${t.name} ã§ã‚¨ãƒ©ãƒ¼:`, e.message);
              try{ await page.close(); }catch{}
              continue;
            }
          }

          await ctx.close();
          await browser.close();

          // çŠ¶æ…‹ä¿å­˜
          fs.writeFileSync(STATE_FILE, JSON.stringify(state, null, 2));
          console.log('Watch å®Œäº†');
          EOF

      - name: Commit last_seen.json
        run: |
          if git status --porcelain | grep -q "last_seen.json"; then
            git config user.name  "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add last_seen.json
            git commit -m "chore: update last_seen.json"
            git push
          else
            echo "no changes"
          fi
