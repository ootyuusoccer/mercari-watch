name: Mercari Watch

on:
  schedule:
    - cron: "*/15 * * * *" # 15分ごとに実行
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set Up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install playwright@1.44.0 node-fetch@3.3.2

      - name: Install Playwright (browsers)
        run: |
          npm i -D playwright
          npx playwright install --with-deps chromium

      - name: Run Mercari Watcher
        run: |
          node <<'EOF'
          import fs from 'fs';
          import fetch from 'node-fetch';
          import { chromium } from 'playwright';

          const targets = fs.readFileSync('targets.csv', 'utf8')
            .trim()
            .split('\n')
            .slice(1)
            .map(line => {
              const [name, url, max_price] = line.split(',');
              return { name, url, max_price: parseInt(max_price, 10) };
            });

          const browser = await chromium.launch();
          const page = await browser.newPage();

          for (const t of targets) {
            console.log(`🔍 Checking: ${t.name}`);
            await page.goto(t.url, { waitUntil: 'domcontentloaded', timeout: 60000 });

            const priceElements = await page.$$eval('div[data-testid="item-price"]', els =>
                els.map(e => e.textContent)
            );

            const prices = priceElements
              .map(p => p.replace(/[^\d]/g, ''))
              .filter(p => p)
              .map(Number);

            if (prices.length > 0) {
              const minPrice = Math.min(...prices);
              console.log(`💰 ${t.name}: 最安値 ${minPrice}円 (上限 ${t.max_price}円)`);

              if (minPrice <= t.max_price) {
                console.log(`🚨 条件一致: ${t.name} が ${minPrice}円で出品中！`);
              }
            } else {
              console.log(`⚠️ ${t.name}: 価格情報が取得できませんでした`);
            }
          }

          await browser.close();
          console.log("✅ Watch 完了");
          EOF
